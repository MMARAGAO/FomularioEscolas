{% extends 'app/layout.html' %} {% block content %}

<style>
  /* Adicione estilos CSS personalizados aqui, se necessário */
  .card {
    /* posicionar no meio da pagina */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70%;

    border-radius: 30px;
    border: none;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
    padding: 20px;
    background-color: #fff;
    /* bordas arredondadas */
  }
  /* botões de avançar e voltar */
  .buttonicon {
    background: white;
    color: #0056b3;
    border: none;
    /* circulo */
    border-radius: 50%;
    /* fazer sombra mais forte e maior (aumentei o valor para 10px de difusão) */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    /* tamanho */
    width: 50px;
    height: 50px;
  }
  .buttonicon:hover {
    color: #0056b3;
  }
  /* botão de enviar */
  .submit {
    background-color: #007bff;
    color: #fff;
    border-radius: 30px;
    padding: 10px 20px;
    border: none;
    outline: none;
    cursor: pointer;
    font-size: 1.2rem;
    margin: 0 10px;
  }
  .submit:hover {
    background-color: #0056b3;
  }
  /* barra de progresso */
  .progress {
    height: 20px;
    background-color: #e9ecef;
    border-radius: 30px;
    margin-bottom: 20px;
  }
  .progress-bar {
    background-color: #007bff;
    border-radius: 30px;
  }
  /* opções de resposta */
  .response-options {
    display: flex;
    flex-direction: column;
    margin-top: 10px;
  }
  .response-option {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .response-option input {
    margin-right: 10px;
  }
  .buttonsq2 {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding-left: 50px;
    padding-right: 50px;
  }
  .question-label {
    font-size: 1.5rem;
    font-weight: bold;
  }
  .question {
    margin-bottom: 20px;
  }
  /* alternativas */
  .response-option label {
    font-size: 1.2rem;
  }
  /* check box */
  .response-option input[type="checkbox"] {
    width: 20px;
    height: 20px;
  }
  .response-option input[type="checkbox"]:checked {
    background-color: #007bff;
  }
  .response-option input[type="checkbox"]:hover {
    background-color: #0056b3;
  }
  .response-option input[type="checkbox"]:focus {
    outline: none;
  }
  .response-option input[type="checkbox"]:checked:after {
    content: "\f00c";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    font-size: 1.2rem;
    color: white;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    text-align: center;
    line-height: 20px;
  }
  /* radio button */
  .response-option input[type="radio"] {
    width: 20px;
    height: 20px;
  }
  /* espaço entre o titulo questionario */
  .card h1 {
    margin-bottom: 50px;
    /* posicionar no meio */
    text-align: center;
  }
  /* espaço da barra de % */
  .progress {
    margin-bottom: 50px;
    height: 30px;
    /* fazer somrbra */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
  }
  /* espaço da pergunta */
  .question-label {
    margin-bottom: 50px;
  }
  .response-options {
    margin-bottom: 50px;
  }
  /* personalize a porcentagem */
  .progress-bar {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
    line-height: 20px;
  }
  /* footer no final da pagina */
  .footer {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    background-color: #2a2c39e6;
  }
</style>

<div class="card" style="padding: 50px">
  <h1>Questionnaire</h1>
  <form method="post">
    {% csrf_token %}
    <div class="progress">
      <div
        class="progress-bar"
        role="progressbar"
        style="width: 0%"
        aria-valuenow="0"
        aria-valuemin="0"
        aria-valuemax="100"
      ></div>
    </div>

    {% for risk_factor in risk_factors %}
    <div
      class="question"
      data-id="{{ risk_factor.id }}"
      data-depends-on="{% if risk_factor.depends_on %}{{ risk_factor.depends_on.id }}{% endif %}"
      data-trigger-response="{{ risk_factor.trigger_response.all|join:', ' }}"
      {%
      if
      not
      forloop.first
      %}style="display: none;"
      {%
      endif
      %}
    >
      <label class="question-label">{{ risk_factor.question }}</label>
      <div class="response-options">
        {% for response in risk_factor.responses.all %}
        <div class="response-option">
          <input
            type="radio"
            name="response_{{ risk_factor.id }}"
            value="{{ response.id }}"
            id="response_{{ risk_factor.id }}_{{ response.id }}"
          />
          <label for="response_{{ risk_factor.id }}_{{ response.id }}"
            >{{ response.text }}</label
          >
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    <div class="buttonsq2">
      <button class="buttonicon" type="button" onclick="prevQuestion()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <button class="submit" type="button" onclick="saveAndContinueLater()">
        Save and Continue Later
      </button>
      <button
        class="buttonicon"
        type="button"
        onclick="nextQuestion()"
        id="next-button"
      >
        <i class="fas fa-arrow-right"></i>
      </button>

      <input type="submit" value="Submit" id="submit-button" />
    </div>
    {{ response_id_to_text|json_script:"response-id-to-text" }}
  </form>
</div>
<footer class="footer" id="footer">
  <div class="container">
    <div class="copyright">
      &copy; Copyright <strong><span>Escola Segura</span></strong
      >. All Rights Reserved
    </div>
  </div>
</footer>
<!-- End Footer -->

<!-- importar icones -->
<script
  src="https://kit.fontawesome.com/2c36e9b7b1.js"
  crossorigin="anonymous"
></script>

<script type="text/javascript">
  const userAnswers = {{ user_answers|safe }};
  console.log(userAnswers);  // Adicione esta linha para depuração
  function markSavedResponses() {
      for (const [key, value] of Object.entries(userAnswers)) {
          const inputElement = document.querySelector(`input[name="${key}"][value="${value}"]`);
          if (inputElement) {
              inputElement.checked = true;
          }
      }
  }
  document.addEventListener('DOMContentLoaded', function () {
      markSavedResponses();

      const questions = document.querySelectorAll('.question');

      let currentQuestionIndex = 0;

      // Find the last answered question
      for (let i = 0; i < questions.length; i++) {
          const questionId = questions[i].getAttribute('data-id');
          if (userAnswers.hasOwnProperty(`response_${questionId}`)) {
              currentQuestionIndex = i;  // Update the currentQuestionIndex if an answer is found
          }
      }

      // Hide all questions initially
      questions.forEach(question => {
          question.style.display = 'none';
      });

      // Show the current question
      questions[currentQuestionIndex].style.display = 'block';

  const responseIdToText = JSON.parse(document.getElementById('response-id-to-text').textContent);

  updateButtons();
  updateProgressBar();  // Moved this line here


      function updateProgressBar() {
          const progressBar = document.querySelector('.progress-bar');
          const progress = (currentQuestionIndex / questions.length) * 100;
          progressBar.style.width = progress + '%';
          progressBar.setAttribute('aria-valuenow', progress);
        //   adicione o valor da porcentagem
            progressBar.innerHTML = progress.toFixed(0) + '%';


      }

  function checkDependencies(question) {
      const dependsOn = question.getAttribute('data-depends-on');
      const triggerResponsesStr = question.getAttribute('data-trigger-response');

      console.log(`Checking dependencies for question: ${question.querySelector('.question-label').textContent}`);
      console.log(`dependsOn: ${dependsOn}`);
      console.log(`triggerResponsesStr: ${triggerResponsesStr}`);

      if (dependsOn) {
          const triggerResponses = triggerResponsesStr ? triggerResponsesStr.split(", ") : null;

          console.log(`triggerResponses: ${triggerResponses}`);

          const dependencyResponseElements = document.querySelectorAll(`[name=response_${dependsOn}]`);
          let dependencyResponseId;
          dependencyResponseElements.forEach((elem) => {
              if (elem.checked) {
                  dependencyResponseId = elem.value;
              }
          });

          if (dependencyResponseId) {
              const dependencyResponseText = responseIdToText[dependencyResponseId];

              console.log(`dependencyResponseText: ${dependencyResponseText}`);

              if (triggerResponses && !triggerResponses.includes(dependencyResponseText)) {
                  console.log('adasdasdasd', triggerResponses);
                  console.log('fudeu', triggerResponses.includes(dependencyResponseText));
                  console.log('Dependency not met, hiding question');
                  return false;
              }
          }
      }

      console.log('No dependencies or dependency met, showing question');
      return true;
  }


  window.saveAndContinueLater = function () {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

      const questions = document.querySelectorAll('.question');
      questions.forEach((question, index) => {
          const risk_factor_id = question.getAttribute('data-id');
          const checkedInput = question.querySelector('input:checked');
          if (checkedInput) {
              const response_id = checkedInput.value;
              formData.append('response_' + risk_factor_id, response_id);
          }
      });

      fetch('/save-temporary-responses/', {
          method: 'POST',
          body: formData,
      })
          .then(response => response.json())
          .then(data => {
              console.log(data);

              // Redirect to homepage after successful save
              window.location.href = '/';

          });
  };






      function checkAllDependencies() {
          questions.forEach((question, index) => {
              if (checkDependencies(question)) {
                  question.style.display = (index === currentQuestionIndex) ? 'block' : 'none';
              } else {
                  question.style.display = 'none';
              }
          });
      }

  window.nextQuestion = function () {
      const currentQuestion = questions[currentQuestionIndex];
      const hasAnswer = currentQuestion.querySelector('input:checked');
      if (!hasAnswer) {
          alert('Please answer the current question before proceeding.');
          return;
      }
      questions[currentQuestionIndex].style.display = 'none';
      do {
          currentQuestionIndex = Math.min(currentQuestionIndex + 1, questions.length - 1);
      } while (!checkDependencies(questions[currentQuestionIndex]) && currentQuestionIndex < questions.length - 1);
      questions[currentQuestionIndex].style.display = 'block';  // Adicionado esta linha
      updateProgressBar();
      updateButtons();
  };

  window.prevQuestion = function () {
      questions[currentQuestionIndex].style.display = 'none';
      do {
          currentQuestionIndex = Math.max(currentQuestionIndex - 1, 0);
      } while (!checkDependencies(questions[currentQuestionIndex]) && currentQuestionIndex > 0);
      questions[currentQuestionIndex].style.display = 'block';  // Adicionado esta linha
      updateProgressBar();
      updateButtons();
  };

  function updateButtons() {
      const nextButton = document.getElementById('next-button');
      const submitButton = document.getElementById('submit-button');
      if (currentQuestionIndex === questions.length - 1) {
          nextButton.style.display = 'none';
          submitButton.style.display = 'block';
      } else {
          nextButton.style.display = 'block';
          submitButton.style.display = 'none';
      }
  }





      updateProgressBar();

  questions.forEach((question, index) => {
      const select = question.querySelector('select');
      if (select) {
          select.addEventListener('change', () => {
              checkAllDependencies();
          });
      }
  });


      // Verificando as dependências iniciais
      checkAllDependencies();
  });
</script>

{% endblock %}
